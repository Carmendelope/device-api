parameters:
  kubeconfig: $HOME/.kube/config
  namespace: nalej
  resourceKind: ""
  resourceName: ""

steps:
  - script: |
      isOk=1
      for (( i=0; i<36; i++ ))
      do
        expected=$(kubectl --kubeconfig ${{ parameters.kubeconfig }} -n ${{ parameters.namespace }} get ${{ parameters.resourceKind }} ${{ parameters.resourceName }} -o=jsonpath='{.spec.replicas}')
        ready=$(kubectl --kubeconfig ${{ parameters.kubeconfig }} -n ${{ parameters.namespace }} get ${{ parameters.resourceKind }} ${{ parameters.resourceName }} -o=jsonpath='{.status.readyReplicas}')
        echo "Expected: $expected"
        echo "Ready: $expected"
        if [ "$expected" == "$ready" ]; then
          isOk=0
          break
        else
          echo "Not ready yet, waiting 10 seconds"
          echo ""
          sleep 10
        fi
      done
      exit $isOk
    displayName: Verify kubernetes resources are running
    continueOnError: true
